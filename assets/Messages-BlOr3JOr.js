import{j as e,L as s,y as a,r as t,U as r,V as i}from"./vendor-ui-CAOOb9ur.js";import{h as n,r as l}from"./vendor-react-C_40T_Qy.js";import{u as o}from"./useQuery-DUJaOdb7.js";import{m as c,B as d,o as m,z as x,E as h,F as j}from"./index-CHW3rl59.js";import{u}from"./useMutation-BLaKMTe8.js";import{I as g}from"./input-DjJBUjUv.js";import{A as v,a as f,b as p}from"./avatar-Cbexax3d.js";import{O as N}from"./OptimizedImage-ChM7nsgN.js";import{S as y,H as b}from"./Header--VKnAQ8w.js";import{H as w}from"./HostHeader-lYBdj6_w.js";import{M as _}from"./MobileNav-BjWHwsxL.js";import{u as I}from"./useTranslation-DgYtz7Wb.js";import{f as M}from"./fr-qjbnyBeO.js";import{e as S,f as k}from"./vendor-utils-tyqSID0v.js";import"./vendor-charts-knjLkUkQ.js";import"./LanguageSwitcher-CRTEz5Uf.js";import"./index-BzbEf57Q.js";import"./sheet-BX1Mcph7.js";const q=()=>{const{t:q,i18n:z}=I(),F="fr"===z.language?M:S,[H,L]=n(),C=H.get("conversationId"),K="host"===H.get("view"),[P,D]=l.useState(C),[A,E]=l.useState(""),O=l.useRef(null),Q=c(),{data:T,isLoading:V}=o({queryKey:["conversations"],queryFn:h}),{data:B,isLoading:R}=o({queryKey:["messages",P],queryFn:()=>j(P),enabled:!!P,refetchInterval:5e3}),U=u({mutationFn:({conversationId:e,content:s})=>x(e,s),onSuccess:()=>{E(""),Q.invalidateQueries({queryKey:["messages",P]}),Q.invalidateQueries({queryKey:["conversations"]})}});l.useEffect(()=>{O.current&&O.current.scrollIntoView({behavior:"smooth"})},[B]),l.useEffect(()=>{C?D(C):T&&T.length>0&&!P&&D(T[0].conversation.id)},[C,T]);const Y=null==T?void 0:T.find(e=>e.conversation.id===P),Z=parseInt(localStorage.getItem("userId")||"0");return V?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(s,{className:"h-8 w-8 animate-spin"})}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(y,{title:q("messages.title","Messages"),description:"Manage your communications with hosts and guests on Le Mboko."}),K?e.jsx(w,{}):e.jsx(b,{}),e.jsx("div",{className:"pt-8 pb-10",children:e.jsx("div",{className:"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 h-[calc(100vh-140px)]",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border overflow-hidden h-full flex",children:[e.jsxs("div",{className:"w-full md:w-1/3 border-r flex flex-col "+(P?"hidden md:flex":"flex"),children:[e.jsxs("div",{className:"p-4 border-b",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:q("messages.title","Messages")}),e.jsxs("div",{className:"relative",children:[e.jsx(a,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(g,{placeholder:q("messages.searchPlaceholder","Search messages"),className:"pl-9 bg-gray-50 border-gray-200"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:0===(null==T?void 0:T.length)?e.jsx("div",{className:"p-8 text-center text-gray-500",children:q("messages.noMessages","No messages yet")}):null==T?void 0:T.map(s=>{var a,t,r;return e.jsx("div",{onClick:()=>{D(s.conversation.id),L({conversationId:s.conversation.id})},className:"p-4 border-b cursor-pointer hover:bg-gray-50 transition-colors "+(P===s.conversation.id?"bg-gray-50 border-l-4 border-l-black":""),children:e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(v,{className:"h-12 w-12",children:[e.jsx(f,{src:s.other_user.avatar}),e.jsx(p,{children:s.other_user.name.charAt(0)})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsx("h3",{className:"font-semibold truncate",children:s.other_user.name}),s.last_message&&e.jsx("span",{className:"text-xs text-gray-500 whitespace-nowrap ml-2",children:k(new Date(s.last_message.created_at),"MMM d",{locale:F})})]}),e.jsx("p",{className:"text-sm text-gray-600 truncate mb-1",children:s.listing_title}),e.jsx("p",{className:"text-sm truncate "+((null==(a=s.last_message)?void 0:a.read_at)||(null==(t=s.last_message)?void 0:t.sender_id)===Z?"text-gray-500":"font-bold text-black"),children:(null==(r=s.last_message)?void 0:r.content)||q("messages.noMessages","No messages yet")})]})]})},s.conversation.id)})})]}),e.jsx("div",{className:"flex-1 flex flex-col "+(P?"flex":"hidden md:flex"),children:Y?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(d,{variant:"ghost",size:"icon",className:"md:hidden",onClick:()=>{D(null),L({})},children:e.jsx(t,{className:"h-5 w-5"})}),e.jsxs(v,{className:"h-10 w-10",children:[e.jsx(f,{src:Y.other_user.avatar}),e.jsx(p,{children:Y.other_user.name.charAt(0)})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:Y.other_user.name}),e.jsx("p",{className:"text-xs text-gray-500",children:q("messages.responseTime",{time:"1 hour",defaultValue:"Response time: 1 hour"})})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[Y.listing_image&&e.jsx(N,{src:m(Y.listing_image),alt:"Listing",className:"h-10 w-10 rounded object-cover hidden sm:block"}),e.jsx(d,{variant:"ghost",size:"icon",children:e.jsx(r,{className:"h-5 w-5"})})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 bg-white",children:[R?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(s,{className:"h-6 w-6 animate-spin text-gray-400"})}):null==B?void 0:B.map(s=>{const a=s.sender_id===Z;return e.jsx("div",{className:"flex "+(a?"justify-end":"justify-start"),children:e.jsxs("div",{className:"max-w-[70%] rounded-2xl px-4 py-2 "+(a?"bg-black text-white rounded-tr-none":"bg-gray-100 text-gray-900 rounded-tl-none"),children:[e.jsx("p",{className:"text-sm",children:s.content}),e.jsx("div",{className:"text-[10px] mt-1 "+(a?"text-gray-400":"text-gray-500"),children:k(new Date(s.created_at),"h:mm a",{locale:F})})]})},s.id)}),e.jsx("div",{ref:O})]}),e.jsx("div",{className:"p-4 border-t",children:e.jsxs("form",{onSubmit:e=>{e.preventDefault(),A.trim()&&P&&U.mutate({conversationId:P,content:A})},className:"flex gap-2",children:[e.jsx(g,{value:A,onChange:e=>E(e.target.value),placeholder:q("messages.typePlaceholder","Type a message..."),className:"flex-1",disabled:U.isPending}),e.jsx(d,{type:"submit",size:"icon",disabled:!A.trim()||U.isPending,children:U.isPending?e.jsx(s,{className:"h-4 w-4 animate-spin"}):e.jsx(i,{className:"h-4 w-4"})})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-gray-400",children:q("messages.selectConversation","Select a conversation to start messaging")})})]})})}),e.jsx(_,{})]})};export{q as default};
