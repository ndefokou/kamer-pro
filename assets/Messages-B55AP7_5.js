import{j as e,L as s,y as a,r as t,U as r,V as i}from"./vendor-ui-DcvuiMJW.js";import{j as n,r as l}from"./vendor-react-CPc5zwff.js";import{u as o}from"./useQuery-LvoaILWK.js";import{e as c,x as d,y as m,B as x,n as h,z as j}from"./index-Dd0d9_cy.js";import{u}from"./useMutation-BnO1s6ox.js";import{I as g}from"./input-aNpEl8VP.js";import{A as v,a as f,b as p}from"./avatar-gH7DVWRa.js";import{O as N}from"./OptimizedImage-Dw--M-ma.js";import{S as y,H as b}from"./Header-C1YZcuTT.js";import{H as w}from"./HostHeader-BiFjD5el.js";import{M as _}from"./MobileNav-Dn4rtq4e.js";import{u as M}from"./useTranslation-BTMhbqKL.js";import{f as I}from"./fr-qjbnyBeO.js";import{e as S,f as k}from"./vendor-utils-tyqSID0v.js";import"./useBaseQuery-DtuBwOHy.js";import"./vendor-charts-CNjKuHaK.js";import"./LanguageSwitcher-DhNIQqEN.js";import"./index-B9HPLTtY.js";import"./sheet-DJPxDHJG.js";const L=()=>{const{t:L,i18n:q}=M(),H="fr"===q.language?I:S,[z,C]=n(),F=z.get("conversationId"),K="host"===z.get("view"),[P,A]=l.useState(F),[Q,B]=l.useState(""),D=l.useRef(null),E=c(),{data:T,isLoading:V}=o({queryKey:["conversations"],queryFn:d}),{data:O,isLoading:R}=o({queryKey:["messages",P],queryFn:()=>m(P),enabled:!!P,refetchInterval:5e3}),U=u({mutationFn:({conversationId:e,content:s})=>j(e,s),onSuccess:()=>{B(""),E.invalidateQueries({queryKey:["messages",P]}),E.invalidateQueries({queryKey:["conversations"]})}});l.useEffect(()=>{D.current&&D.current.scrollIntoView({behavior:"smooth"})},[O]),l.useEffect(()=>{F?A(F):T&&T.length>0&&!P&&A(T[0].conversation.id)},[F,T]);const X=null==T?void 0:T.find(e=>e.conversation.id===P),Y=parseInt(localStorage.getItem("userId")||"0");return V?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(s,{className:"h-8 w-8 animate-spin"})}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(y,{title:L("messages.title","Messages"),description:"Manage your communications with hosts and guests on Le Mboko."}),K?e.jsx(w,{}):e.jsx(b,{}),e.jsx("div",{className:"pt-8 pb-10",children:e.jsx("div",{className:"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 h-[calc(100vh-140px)]",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border overflow-hidden h-full flex",children:[e.jsxs("div",{className:"w-full md:w-1/3 border-r flex flex-col "+(P?"hidden md:flex":"flex"),children:[e.jsxs("div",{className:"p-4 border-b",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:L("messages.title","Messages")}),e.jsxs("div",{className:"relative",children:[e.jsx(a,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(g,{placeholder:L("messages.searchPlaceholder","Search messages"),className:"pl-9 bg-gray-50 border-gray-200"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:0===(null==T?void 0:T.length)?e.jsx("div",{className:"p-8 text-center text-gray-500",children:L("messages.noMessages","No messages yet")}):null==T?void 0:T.map(s=>{var a,t,r;return e.jsx("div",{onClick:()=>{A(s.conversation.id),C({conversationId:s.conversation.id})},className:"p-4 border-b cursor-pointer hover:bg-gray-50 transition-colors "+(P===s.conversation.id?"bg-gray-50 border-l-4 border-l-black":""),children:e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(v,{className:"h-12 w-12",children:[e.jsx(f,{src:s.other_user.avatar}),e.jsx(p,{children:s.other_user.name.charAt(0)})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsx("h3",{className:"font-semibold truncate",children:s.other_user.name}),s.last_message&&e.jsx("span",{className:"text-xs text-gray-500 whitespace-nowrap ml-2",children:k(new Date(s.last_message.created_at),"MMM d",{locale:H})})]}),e.jsx("p",{className:"text-sm text-gray-600 truncate mb-1",children:s.listing_title}),e.jsx("p",{className:"text-sm truncate "+((null==(a=s.last_message)?void 0:a.read_at)||(null==(t=s.last_message)?void 0:t.sender_id)===Y?"text-gray-500":"font-bold text-black"),children:(null==(r=s.last_message)?void 0:r.content)||L("messages.noMessages","No messages yet")})]})]})},s.conversation.id)})})]}),e.jsx("div",{className:"flex-1 flex flex-col "+(P?"flex":"hidden md:flex"),children:X?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(x,{variant:"ghost",size:"icon",className:"md:hidden",onClick:()=>{A(null),C({})},children:e.jsx(t,{className:"h-5 w-5"})}),e.jsxs(v,{className:"h-10 w-10",children:[e.jsx(f,{src:X.other_user.avatar}),e.jsx(p,{children:X.other_user.name.charAt(0)})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:X.other_user.name}),e.jsx("p",{className:"text-xs text-gray-500",children:L("messages.responseTime",{time:"1 hour",defaultValue:"Response time: 1 hour"})})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[X.listing_image&&e.jsx(N,{src:h(X.listing_image),alt:"Listing",className:"h-10 w-10 rounded object-cover hidden sm:block"}),e.jsx(x,{variant:"ghost",size:"icon",children:e.jsx(r,{className:"h-5 w-5"})})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 bg-white",children:[R?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(s,{className:"h-6 w-6 animate-spin text-gray-400"})}):null==O?void 0:O.map(s=>{const a=s.sender_id===Y;return e.jsx("div",{className:"flex "+(a?"justify-end":"justify-start"),children:e.jsxs("div",{className:"max-w-[70%] rounded-2xl px-4 py-2 "+(a?"bg-black text-white rounded-tr-none":"bg-gray-100 text-gray-900 rounded-tl-none"),children:[e.jsx("p",{className:"text-sm",children:s.content}),e.jsx("div",{className:"text-[10px] mt-1 "+(a?"text-gray-400":"text-gray-500"),children:k(new Date(s.created_at),"h:mm a",{locale:H})})]})},s.id)}),e.jsx("div",{ref:D})]}),e.jsx("div",{className:"p-4 border-t",children:e.jsxs("form",{onSubmit:e=>{e.preventDefault(),Q.trim()&&P&&U.mutate({conversationId:P,content:Q})},className:"flex gap-2",children:[e.jsx(g,{value:Q,onChange:e=>B(e.target.value),placeholder:L("messages.typePlaceholder","Type a message..."),className:"flex-1",disabled:U.isPending}),e.jsx(x,{type:"submit",size:"icon",disabled:!Q.trim()||U.isPending,children:U.isPending?e.jsx(s,{className:"h-4 w-4 animate-spin"}):e.jsx(i,{className:"h-4 w-4"})})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-gray-400",children:L("messages.selectConversation","Select a conversation to start messaging")})})]})})}),e.jsx(_,{})]})};export{L as default};
